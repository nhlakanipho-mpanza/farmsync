<div class="main-content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header card-header-primary">
            <h4 class="card-title">Receive Goods</h4>
            <p class="card-category">
              {{ purchaseOrder ? 'Record goods receipt for PO: ' + purchaseOrder.poNumber : 'Select a purchase order to receive goods' }}
            </p>
          </div>
          <div class="card-body">
            <!-- PO Selector when no PO is pre-selected -->
            <div *ngIf="showPOSelector && !purchaseOrder">
              <div class="row">
                <div class="col-md-6">
                  <mat-form-field class="w-100">
                    <mat-label>Select Purchase Order</mat-label>
                    <mat-select (selectionChange)="onPOSelected($event.value)">
                      <mat-option *ngFor="let po of availablePOs" [value]="po.id">
                        {{ po.poNumber }} - {{ po.supplierName }} ({{ po.orderDate | date: 'dd/MM/yyyy' }})
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
              <div *ngIf="availablePOs.length === 0 && !loading" class="alert alert-info">
                No approved purchase orders available for receiving goods.
                <a routerLink="/procurement/purchase-orders">Go to Purchase Orders</a>
              </div>
            </div>

            <!-- Loading spinner -->
            <div *ngIf="loading" class="text-center">
              <mat-spinner></mat-spinner>
            </div>

            <!-- Goods Receipt Form -->
            <form [formGroup]="grForm" (ngSubmit)="onSubmit()" *ngIf="purchaseOrder && !loading">
              <div class="row">
                <div class="col-md-6">
                  <div class="info-item">
                    <strong>Supplier:</strong> {{ purchaseOrder.supplierName }}
                  </div>
                </div>
                <div class="col-md-3">
                  <mat-form-field class="w-100">
                    <mat-label>Receipt Date</mat-label>
                    <input matInput [matDatepicker]="receivedPicker" formControlName="receivedDate" required>
                    <mat-datepicker-toggle matSuffix [for]="receivedPicker"></mat-datepicker-toggle>
                    <mat-datepicker #receivedPicker></mat-datepicker>
                  </mat-form-field>
                </div>
              </div>

              <hr>
              <h5>Items to Receive</h5>
              <p class="text-muted">
                <mat-icon inline style="font-size: 16px; vertical-align: middle;">info</mat-icon>
                Received quantity is locked to remaining quantity. Use "Damaged" field to record issues.
              </p>

              <div formArrayName="items">
                <div *ngFor="let item of items.controls; let i = index" [formGroupName]="i" class="item-row">
                  <div class="row">
                    <div class="col-md-12">
                      <h6>{{ item.get('itemName')?.value }}</h6>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-2">
                      <mat-form-field class="w-100">
                        <mat-label>Ordered</mat-label>
                        <input matInput formControlName="orderedQuantity" readonly>
                      </mat-form-field>
                    </div>

                    <div class="col-md-2">
                      <mat-form-field class="w-100">
                        <mat-label>Previously Received</mat-label>
                        <input matInput formControlName="previouslyReceived" readonly>
                      </mat-form-field>
                    </div>

                    <div class="col-md-2">
                      <mat-form-field class="w-100">
                        <mat-label>Remaining to Receive</mat-label>
                        <input matInput formControlName="remainingQuantity" readonly>
                      </mat-form-field>
                    </div>

                    <div class="col-md-2">
                      <mat-form-field class="w-100">
                        <mat-label>Quantity Received</mat-label>
                        <input matInput type="number" formControlName="quantityReceived" readonly>
                        <mat-hint>Locked</mat-hint>
                      </mat-form-field>
                    </div>

                    <div class="col-md-2">
                      <mat-form-field class="w-100">
                        <mat-label>Damaged</mat-label>
                        <input matInput type="number" formControlName="quantityDamaged" 
                               (change)="onDamagedChange(i)" min="0">
                        <mat-hint>Items damaged/defective</mat-hint>
                      </mat-form-field>
                    </div>

                    <div class="col-md-2">
                      <mat-form-field class="w-100">
                        <mat-label>Shortfall</mat-label>
                        <input matInput type="number" formControlName="quantityShortfall" min="0" readonly>
                        <mat-hint>Auto-calculated</mat-hint>
                      </mat-form-field>
                    </div>

                    <div class="col-md-2">
                      <mat-form-field class="w-100">
                        <mat-label>Condition</mat-label>
                        <mat-select formControlName="condition" required>
                          <mat-option value="Excellent">Excellent</mat-option>
                          <mat-option value="Good">Good</mat-option>
                          <mat-option value="Fair">Fair</mat-option>
                          <mat-option value="Poor">Poor</mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-12">
                      <mat-form-field class="w-100">
                        <mat-label>Notes</mat-label>
                        <input matInput formControlName="notes">
                      </mat-form-field>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row" *ngIf="hasDiscrepancies()">
                <div class="col-md-12">
                  <div class="alert alert-warning mb-3">
                    <mat-icon>warning</mat-icon>
                    <strong>Discrepancies Detected:</strong> Damaged or missing items found.
                  </div>
                  
                  <mat-checkbox formControlName="isFinalReceipt" (change)="onFinalReceiptChange($event.checked)">
                    <strong>Mark as Final Receipt</strong>
                    <p class="text-muted mb-0" style="font-size: 12px;">
                      Check this if supplier will NOT deliver the missing/damaged items. 
                      This will close the purchase order and update inventory with actual received quantity only.
                    </p>
                  </mat-checkbox>

                  <mat-form-field class="w-100 mt-3">
                    <mat-label>Discrepancy Notes (Required)</mat-label>
                    <textarea matInput formControlName="discrepancyNotes" rows="3" 
                              placeholder="Explain damaged items or shortfalls..." required></textarea>
                  </mat-form-field>

                  <div class="alert alert-info" *ngIf="!grForm.get('isFinalReceipt')?.value">
                    <mat-icon>info</mat-icon>
                    This receipt will require manager approval. Purchase order remains open for future deliveries.
                  </div>

                  <div class="alert alert-danger" *ngIf="grForm.get('isFinalReceipt')?.value">
                    <mat-icon>block</mat-icon>
                    <strong>Warning:</strong> Marking as final receipt will CLOSE this purchase order. 
                    Inventory will be updated with actual received quantity only (excluding damaged/missing items).
                  </div>
                </div>
              </div>

              <div class="row mt-3">
                <div class="col-md-12 text-right">
                  <button mat-raised-button type="button" class="btn btn-round btn-danger" (click)="cancel()">
                    <mat-icon>cancel</mat-icon>
                    Cancel
                  </button>
                  <button mat-raised-button class="btn btn-round btn-primary" type="submit" [disabled]="grForm.invalid">
                    <mat-icon>check_circle</mat-icon>
                    {{ hasDiscrepancies() && grForm.get('isFinalReceipt')?.value ? 'Submit Final Receipt & Close PO' : 'Submit Receipt' }}
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
